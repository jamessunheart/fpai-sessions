# ORCHESTRATOR - Technical Specification
**Droplet #2** | **Port 8001** | **Status: OFFLINE (Production-ready)**

*Auto-generated by session-1763235028 - Autonomous Value Creation Spree*

## Purpose
Central task routing and orchestration hub for Full Potential AI mesh architecture. Routes HTTP requests to target droplets with retry logic, caching, and graceful degradation.

## Core Capabilities
- **Task Routing:** Routes tasks to target droplets via HTTP with automatic retry
- **Registry Sync:** Maintains cached droplet list with 60-second refresh cycle
- **Resilience:** Exponential backoff retry (3 attempts), disk cache fallback
- **Inter-Droplet Messaging:** Coordinates communication between services
- **Metrics:** Tracks task performance, retry stats, and Registry health

## UBIC Endpoints
✅ `/orchestrator/health` - Service health + dependency status (Registry, cache)
✅ `/orchestrator/capabilities` - Routing capabilities + features
✅ `/orchestrator/state` - Uptime, request metrics, performance stats
✅ `/orchestrator/dependencies` - Registry (required), cache (optional)
✅ `/orchestrator/message` - Inter-droplet messaging receiver
✅ `/orchestrator/send` - Inter-droplet messaging sender

## Service Endpoints

### `POST /orchestrator/tasks`
Submit task to be routed to target droplet
```json
{
  "droplet_name": "registry",
  "method": "GET",
  "path": "/health",
  "payload": null,
  "meta": {"requested_by": "dashboard"}
}
```
**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success",
  "target_url": "http://localhost:8000/health",
  "response_status": 200,
  "response_body": {"status": "ok"},
  "retry_count": 0,
  "duration_ms": 45
}
```

### `GET /orchestrator/tasks`
List task history with filtering
```bash
# Filter by status
GET /orchestrator/tasks?status=success

# Filter by droplet
GET /orchestrator/tasks?droplet_name=registry

# Limit results
GET /orchestrator/tasks?limit=50
```

### `GET /orchestrator/tasks/{task_id}`
Get specific task details
```bash
GET /orchestrator/tasks/550e8400-e29b-41d4-a716-446655440000
```

### `GET /orchestrator/droplets`
List known droplets from Registry cache
```json
{
  "droplets": [
    {"id": 1, "name": "registry", "url": "http://localhost:8000"},
    {"id": 20, "name": "i-proactive", "url": "http://localhost:8400"}
  ],
  "cache_status": "active",
  "served_from": "registry"
}
```

### `GET /orchestrator/metrics`
Operational metrics and performance stats
```json
{
  "service": "orchestrator",
  "version": "1.1.0",
  "uptime_seconds": 3600,
  "tasks": {
    "total": 250,
    "success": 238,
    "error": 8,
    "success_rate_percent": 95.2,
    "avg_response_time_ms": 234,
    "p95_response_time_ms": 1200
  },
  "retry": {
    "total_retries": 12,
    "retry_success_count": 8
  },
  "registry": {
    "syncs_total": 145,
    "syncs_success": 143,
    "cache_age_seconds": 30,
    "cache_status": "active"
  }
}
```

## Architecture

### Resilience Features
- **Registry Cache:** 60-second sync interval, disk persistence, 5-minute expiry
- **Retry Logic:** 3 attempts with exponential backoff (1s, 2s, 4s)
- **Graceful Degradation:** Continues with stale cache if Registry unavailable
- **Error Handling:** UDC-compliant error responses with trace IDs

### Configuration (Environment Variables)
| Variable | Default | Description |
|----------|---------|-------------|
| `REGISTRY_URL` | `http://localhost:8000` | Registry service URL |
| `REGISTRY_SYNC_INTERVAL` | `60` | Seconds between syncs |
| `TASK_TIMEOUT` | `30` | Task timeout in seconds |
| `TASK_MAX_RETRIES` | `3` | Maximum retry attempts |
| `TASK_MAX_HISTORY` | `10000` | Max tasks in memory |

### Task Flow
```
External Request → Orchestrator → Registry (resolve droplet)
                                ↓
                         Target Droplet (with retry)
                                ↓
                         Response + Metrics
```

## Deployment

### Docker
```bash
docker run -d --name orchestrator -p 8001:8001 \
  -e REGISTRY_URL=http://registry:8000 \
  -v /var/cache/fpai:/var/cache/fpai \
  fpai-orchestrator
```

### Local Development
```bash
cd agents/services/orchestrator
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --port 8001 --reload
```

## Current Status: OFFLINE
**Discovered:** 2025-11-15 by session-1763235028 autonomous health check

**Issue:** Service not responding on port 8001
**Impact:** HIGH - Dashboard and inter-service routing affected
**Action Required:** Restart service on production server (198.54.123.234)

```bash
# Recommended fix (requires SSH):
ssh root@198.54.123.234 'docker restart orchestrator'
```

**Critical dependency - many services rely on Orchestrator for inter-droplet communication!**
