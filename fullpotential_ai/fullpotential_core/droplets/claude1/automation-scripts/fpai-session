#!/bin/bash

# üöÄ FPAI Unified Session Manager
# Single command to control all session coordination features

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COORD_DIR="/Users/jamessunheart/Development/docs/coordination"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
üöÄ FPAI Unified Session Manager

${GREEN}Quick Start:${NC}
  fpai-session init           # Initialize and register this session
  fpai-session status         # Show all active sessions
  fpai-session msg            # Check your messages

${BLUE}Session Management:${NC}
  init                        # Register new session
  start                       # Start/resume session
  heartbeat                   # Send heartbeat (keep alive)
  status                      # View all sessions and their status
  me                          # Show my session info

${BLUE}Communication:${NC}
  msg [check]                 # Check messages
  send <to> <subject> <msg>   # Send direct message
  broadcast <subject> <msg>   # Broadcast to all sessions

${BLUE}Work Management:${NC}
  claim <type> <name> <hrs>   # Claim work item
  release                     # Release current work
  working [description]       # Set what you're working on

${BLUE}Knowledge:${NC}
  search <topic>              # Search shared knowledge
  share <type> <title> <desc> # Share learning/pattern

${BLUE}Credentials:${NC}
  creds list                  # List available credentials
  creds get <name>            # Get specific credential
  creds set <name> <value>    # Set credential

${BLUE}Collaboration:${NC}
  discover                    # Find other active sessions
  delegate <session> <task>   # Delegate task to another session
  collaborate <topic>         # Request collaboration

${BLUE}Dashboard:${NC}
  dash                        # Open coordination dashboard
  hub                         # Open dashboard hub

${YELLOW}Examples:${NC}
  fpai-session init
  fpai-session working "Building dashboard hub"
  fpai-session send session-123 "Help needed" "Can you review my PR?"
  fpai-session search "service patterns"
  fpai-session collaborate "dashboard improvements"

EOF
}

get_current_session() {
    if [ -f "$COORD_DIR/.current_session" ]; then
        cat "$COORD_DIR/.current_session"
    else
        echo ""
    fi
}

cmd_init() {
    echo -e "${GREEN}üöÄ Initializing FPAI Session...${NC}"
    cd "$COORD_DIR"
    ./scripts/session-start.sh
    SESSION_ID=$(get_current_session)
    echo -e "${GREEN}‚úÖ Session registered: $SESSION_ID${NC}"
    echo ""
    echo -e "${BLUE}Quick tips:${NC}"
    echo "  ‚Ä¢ Use 'fpai-session status' to see other sessions"
    echo "  ‚Ä¢ Use 'fpai-session msg' to check messages"
    echo "  ‚Ä¢ Use 'fpai-session search <topic>' to find knowledge"
    echo ""
}

cmd_status() {
    cd "$COORD_DIR"
    ./scripts/session-status.sh
}

cmd_me() {
    SESSION_ID=$(get_current_session)
    if [ -z "$SESSION_ID" ]; then
        echo -e "${RED}‚ùå No active session. Run 'fpai-session init' first${NC}"
        exit 1
    fi

    echo -e "${GREEN}üìã Your Session: $SESSION_ID${NC}"
    if [ -f "$COORD_DIR/sessions/$SESSION_ID.json" ]; then
        python3 -c "
import json, sys
with open('$COORD_DIR/sessions/$SESSION_ID.json') as f:
    data = json.load(f)
    print(f\"Status: {data.get('status', 'unknown')}\")
    print(f\"Working on: {data.get('current_work', 'nothing')}\")
    print(f\"Started: {data.get('start_time', 'unknown')}\")
    print(f\"Last heartbeat: {data.get('last_heartbeat', 'never')}\")
" 2>/dev/null || echo "Could not read session file"
    fi
}

cmd_msg() {
    cd "$COORD_DIR"
    ./scripts/session-check-messages.sh
}

cmd_send() {
    if [ $# -lt 3 ]; then
        echo -e "${RED}Usage: fpai-session send <to_session> <subject> <message>${NC}"
        exit 1
    fi
    cd "$COORD_DIR"
    ./scripts/session-send-message.sh "$1" "$2" "$3"
}

cmd_broadcast() {
    if [ $# -lt 2 ]; then
        echo -e "${RED}Usage: fpai-session broadcast <subject> <message>${NC}"
        exit 1
    fi
    cd "$COORD_DIR"
    ./scripts/session-send-message.sh "broadcast" "$1" "$2"
}

cmd_search() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Usage: fpai-session search <topic>${NC}"
        exit 1
    fi
    cd "$COORD_DIR"
    ./scripts/session-search-knowledge.sh "$1"
}

cmd_share() {
    if [ $# -lt 3 ]; then
        echo -e "${RED}Usage: fpai-session share <type> <title> <description>${NC}"
        exit 1
    fi
    cd "$COORD_DIR"
    ./scripts/session-share-learning.sh "$1" "$2" "$3"
}

cmd_discover() {
    echo -e "${GREEN}üîç Discovering Active Sessions...${NC}"
    cd "$COORD_DIR"

    if ! ls sessions/*.json 1> /dev/null 2>&1; then
        echo -e "${YELLOW}No active sessions found${NC}"
        exit 0
    fi

    CURRENT=$(get_current_session)

    echo ""
    for session_file in sessions/*.json; do
        SESSION_ID=$(basename "$session_file" .json)

        if [ "$SESSION_ID" = "$CURRENT" ]; then
            echo -e "${GREEN}üëâ $SESSION_ID (YOU)${NC}"
        else
            echo -e "${BLUE}ü§ñ $SESSION_ID${NC}"
        fi

        python3 -c "
import json
with open('$session_file') as f:
    data = json.load(f)
    work = data.get('current_work', 'idle')
    status = data.get('status', 'unknown')
    print(f'   Status: {status}')
    print(f'   Working on: {work}')
" 2>/dev/null || echo "   Could not read session details"
        echo ""
    done
}

cmd_delegate() {
    if [ $# -lt 2 ]; then
        echo -e "${RED}Usage: fpai-session delegate <session_id> <task_description>${NC}"
        exit 1
    fi

    TO_SESSION="$1"
    TASK="$2"
    CURRENT=$(get_current_session)

    if [ -z "$CURRENT" ]; then
        echo -e "${RED}‚ùå No active session. Run 'fpai-session init' first${NC}"
        exit 1
    fi

    echo -e "${GREEN}üì§ Delegating task to $TO_SESSION...${NC}"
    cd "$COORD_DIR"
    ./scripts/session-send-message.sh "$TO_SESSION" "Task Delegation" "Task delegated from $CURRENT: $TASK"
    echo -e "${GREEN}‚úÖ Task delegation sent${NC}"
}

cmd_collaborate() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Usage: fpai-session collaborate <topic>${NC}"
        exit 1
    fi

    TOPIC="$1"
    CURRENT=$(get_current_session)

    if [ -z "$CURRENT" ]; then
        echo -e "${RED}‚ùå No active session. Run 'fpai-session init' first${NC}"
        exit 1
    fi

    echo -e "${GREEN}ü§ù Broadcasting collaboration request...${NC}"
    cd "$COORD_DIR"
    ./scripts/session-send-message.sh "broadcast" "Collaboration Request: $TOPIC" "$CURRENT is seeking collaboration on: $TOPIC. Interested sessions please respond!"
    echo -e "${GREEN}‚úÖ Collaboration request broadcast${NC}"
}

cmd_working() {
    if [ $# -lt 1 ]; then
        echo -e "${YELLOW}Usage: fpai-session working <description>${NC}"
        echo -e "${YELLOW}Example: fpai-session working \"Building dashboard hub\"${NC}"
        exit 1
    fi

    WORK="$1"
    SESSION_ID=$(get_current_session)

    if [ -z "$SESSION_ID" ]; then
        echo -e "${RED}‚ùå No active session. Run 'fpai-session init' first${NC}"
        exit 1
    fi

    SESSION_FILE="$COORD_DIR/sessions/$SESSION_ID.json"
    if [ -f "$SESSION_FILE" ]; then
        python3 -c "
import json
with open('$SESSION_FILE', 'r') as f:
    data = json.load(f)
data['current_work'] = '$WORK'
data['status'] = 'active'
with open('$SESSION_FILE', 'w') as f:
    json.dump(data, f, indent=2)
"
        echo -e "${GREEN}‚úÖ Updated work status: $WORK${NC}"
    else
        echo -e "${RED}‚ùå Session file not found. Try 'fpai-session init'${NC}"
    fi
}

cmd_dash() {
    echo -e "${GREEN}üéõÔ∏è Opening Coordination Dashboard...${NC}"
    open "https://fullpotential.com/dashboard/coordination" 2>/dev/null || \
    xdg-open "https://fullpotential.com/dashboard/coordination" 2>/dev/null || \
    echo "https://fullpotential.com/dashboard/coordination"
}

cmd_hub() {
    echo -e "${GREEN}üéõÔ∏è Opening Dashboard Hub...${NC}"
    open "https://fullpotential.com/dashboard/" 2>/dev/null || \
    xdg-open "https://fullpotential.com/dashboard/" 2>/dev/null || \
    echo "https://fullpotential.com/dashboard/"
}

# Main command router
case "${1:-help}" in
    help|--help|-h)
        show_help
        ;;
    init)
        cmd_init
        ;;
    start)
        cmd_init
        ;;
    heartbeat)
        cd "$COORD_DIR"
        ./scripts/session-heartbeat.sh
        ;;
    status)
        cmd_status
        ;;
    me)
        cmd_me
        ;;
    msg|messages|check)
        cmd_msg
        ;;
    send)
        shift
        cmd_send "$@"
        ;;
    broadcast|bc)
        shift
        cmd_broadcast "$@"
        ;;
    claim)
        shift
        cd "$COORD_DIR"
        ./scripts/session-claim.sh "$@"
        ;;
    release)
        cd "$COORD_DIR"
        ./scripts/session-release.sh
        ;;
    working)
        shift
        cmd_working "$@"
        ;;
    search)
        shift
        cmd_search "$@"
        ;;
    share)
        shift
        cmd_share "$@"
        ;;
    creds)
        shift
        case "$1" in
            list)
                cd "$COORD_DIR"
                ./scripts/session-list-credentials.sh
                ;;
            get)
                cd "$COORD_DIR"
                ./scripts/session-get-credential.sh "$2"
                ;;
            set)
                cd "$COORD_DIR"
                ./scripts/session-set-credential.sh "$2" "$3"
                ;;
            *)
                echo -e "${RED}Usage: fpai-session creds [list|get|set]${NC}"
                ;;
        esac
        ;;
    discover|find)
        cmd_discover
        ;;
    delegate)
        shift
        cmd_delegate "$@"
        ;;
    collaborate|collab)
        shift
        cmd_collaborate "$@"
        ;;
    dash|dashboard)
        cmd_dash
        ;;
    hub)
        cmd_hub
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
